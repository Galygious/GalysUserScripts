<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Active Monitoring & Recovery Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .success { color: green; }
        .warning { color: orange; }
        .error { color: red; }
        .info { color: blue; }
        code { background: #f4f4f4; padding: 2px 4px; border-radius: 3px; }
        pre { background: #f8f8f8; padding: 10px; border-radius: 5px; overflow-x: auto; }
        .heartbeat { color: #ff6b6b; font-weight: bold; }
        .recovery { color: #4ecdc4; font-weight: bold; }
    </style>
</head>
<body>
    <h1>ğŸ”„ Active Monitoring & Recovery System</h1>

    <div class="test-section">
        <h2>ğŸ“ How It Works</h2>
        <p>The enhanced Auto Color Coder now implements <strong>active monitoring</strong> with <strong>automatic recovery</strong>:</p>

        <h3>1. Immediate Registration</h3>
        <p>When you open any lead page, it immediately:</p>
        <ul>
            <li>Registers the lead as "actively processing"</li>
            <li>Records the URL for potential recovery</li>
            <li>Starts a heartbeat timer (updates every 1 second)</li>
        </ul>

        <h3>2. Heartbeat Monitoring</h3>
        <p>While processing, the script:</p>
        <ul>
            <li>Updates a timestamp every second</li>
            <li>Tracks processing state in real-time</li>
            <li>Maintains a global registry of all active leads</li>
        </ul>

        <h3>3. Failure Detection</h3>
        <p>If a timestamp becomes stale (>5 seconds old):</p>
        <ul>
            <li>Lead is marked as "failed" or "crashed"</li>
            <li>System detects the failure on any admin page visit</li>
            <li>Automatically opens the failed lead in a new tab</li>
        </ul>

        <h3>4. Automatic Recovery</h3>
        <p>Failed leads are automatically:</p>
        <ul>
            <li>Reopened in new tabs</li>
            <li>Resume processing from last completed step</li>
            <li>Cleaned up from active tracking once recovered</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ› ï¸ Menu Commands</h2>
        <p>Three new Tampermonkey menu commands:</p>

        <h3>ğŸ” Check for Failed Leads</h3>
        <p>Manually trigger recovery check:</p>
        <ul>
            <li>Scans for stale timestamps</li>
            <li>Opens any failed leads in new tabs</li>
            <li>Cleans up old tracking data</li>
        </ul>

        <h3>ğŸ“Š Show Active Leads Status</h3>
        <p>View current processing status:</p>
        <ul>
            <li>List all leads being processed</li>
            <li>Show last heartbeat time for each</li>
            <li>Identify potentially stale leads</li>
        </ul>

        <h3>ğŸ§¹ Clear Processing Progress</h3>
        <p>Reset progress for problematic leads</p>
    </div>

    <div class="test-section">
        <h2>ğŸ’“ Heartbeat System</h2>
        <p><span class="heartbeat">Heartbeat updates every 1 second</span> during active processing:</p>

        <h3>Active Processing:</h3>
        <pre><code class="info">[AutoColorCoder] ğŸ“ Registered lead 12345 as active
[AutoColorCoder] ğŸ’“ Started heartbeat for lead 12345
[AutoColorCoder] ğŸ’“ Heartbeat: 0s ago
[AutoColorCoder] ğŸ’“ Heartbeat: 1s ago
[AutoColorCoder] ğŸ’“ Heartbeat: 2s ago
...</code></pre>

        <h3>Failure Detection:</h3>
        <pre><code class="warning">[AutoColorCoder] ğŸš¨ Found 1 stale leads to recover:
  - Lead 12345: 8s ago (https://pixifi.com/admin/leads/12345)
[AutoColorCoder] ğŸ”„ Recovering lead 12345...
[AutoColorCoder] ğŸ†• Opened lead 12345 for recovery</code></pre>

        <h3>Successful Completion:</h3>
        <pre><code class="success">[AutoColorCoder] âœ… Lead 12345 fully processed, cleaned up all tracking.
[AutoColorCoder] ğŸ’” Stopped heartbeat</code></pre>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª Testing the System</h2>

        <h3>Test Scenario 1: Browser Crash Recovery</h3>
        <ol>
            <li>Open a lead page - script starts processing</li>
            <li><strong>Force quit browser</strong> (or kill the tab)</li>
            <li>Reopen browser and go to any Pixifi admin page</li>
            <li>Observe: Failed lead automatically reopens</li>
        </ol>

        <h3>Test Scenario 2: Power Outage Simulation</h3>
        <ol>
            <li>Start processing multiple leads</li>
            <li><strong>Close all browser windows</strong></li>
            <li>Wait 10+ seconds</li>
            <li>Reopen browser and visit admin page</li>
            <li>Observe: All failed leads reopen automatically</li>
        </ol>

        <h3>Test Scenario 3: Manual Recovery Check</h3>
        <ol>
            <li>Use "Check for Failed Leads" menu command</li>
            <li>View recovery logs in console</li>
            <li>Observe new tabs opening for failed leads</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>âš™ï¸ Technical Details</h2>

        <h3>Storage Keys:</h3>
        <ul>
            <li><code>acc_active_[leadID]</code> - Individual lead heartbeat data</li>
            <li><code>acc_registry</code> - Global registry of active leads</li>
            <li><code>acc_progress_[leadID]</code> - Processing step progress</li>
            <li><code>acc_done_[leadID]</code> - Completion flags</li>
        </ul>

        <h3>Timings:</h3>
        <ul>
            <li><strong>Heartbeat Interval:</strong> 1 second</li>
            <li><strong>Stale Threshold:</strong> 5 seconds</li>
            <li><strong>Recovery Check:</strong> On every admin page load</li>
        </ul>

        <h3>Cleanup Strategy:</h3>
        <ul>
            <li>Active tracking: Cleared when processing completes or fails</li>
            <li>Progress tracking: Kept until fully complete</li>
            <li>Done flags: Permanent completion markers</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸš€ Benefits</h2>
        <ul>
            <li><strong>Zero Data Loss:</strong> Never lose track of processing state</li>
            <li><strong>Automatic Recovery:</strong> Failed leads reopen themselves</li>
            <li><strong>Real-time Monitoring:</strong> Know exactly what's processing</li>
            <li><strong>Resilient:</strong> Survives browser crashes, power outages, system restarts</li>
            <li><strong>Non-intrusive:</strong> Recovery happens in background</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ Troubleshooting</h2>

        <h3>If Recovery Doesn't Work:</h3>
        <ul>
            <li>Check browser console for error messages</li>
            <li>Use "Show Active Leads Status" to see current state</li>
            <li>Use "Clear Processing Progress" for stuck leads</li>
            <li>Ensure popup blockers aren't preventing new tabs</li>
        </ul>

        <h3>Debug Information:</h3>
        <p>Enable debug mode and watch for these log patterns:</p>
        <ul>
            <li><code>ğŸ“ Registered lead [ID] as active</code></li>
            <li><code>ğŸ’“ Started heartbeat for lead [ID]</code></li>
            <li><code>ğŸš¨ Found [N] stale leads to recover</code></li>
            <li><code>âœ… Lead [ID] fully processed</code></li>
        </ul>
    </div>
</body>
</html>
